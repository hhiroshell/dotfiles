# ==============================================================================
# General Settings
# ==============================================================================

# Terminal support
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:RGB"
set -sg escape-time 0  # Eliminate escape key delay
set -g history-limit 50000

# Base indices
set -g base-index 1           # Start window numbering at 1
setw -g pane-base-index 1     # Start pane numbering at 1

# ==============================================================================
# Appearance
# ==============================================================================

# Status bar
set -g status-position top
set -g status-style "fg=black, bg=lightgray"
set -g status-left '#{?pane_in_mode,#[fg=white bg=magenta]  COPY  #[default],#{?client_prefix,#[fg=white bg=green] PREFIX #[default],#[fg=white bg=blue] NORMAL #[default]}} '
set -g status-right ''

# Window status
setw -g window-status-style "fg=blue, bg=lightgray"
setw -g window-status-format ' #I #[fg=black]#W #F '
setw -g window-status-current-style "bold, fg=black, bg=#f0edec"
setw -g window-status-current-format ' #I #W #F '
setw -g window-status-activity-style "bold, underscore"

# Pane borders
set -g pane-border-lines simple
set -g pane-border-style "fg=#b0aeac"
set -g pane-active-border-style "bold, fg=#505050"

# Messages
set -g message-style "fg=black, bg=#f0edec"
set -g message-command-style "fg=black, bg=#f0edec"

# Copy mode style
set -g mode-style "fg=black, bg=lightgray"
set -g copy-mode-match-style "fg=black, bg=lightgray"
set -g copy-mode-current-match-style "fg=black, bg=gray, bold"

# Popup style
set -g popup-border-style "fg=gray"

# Clock
set -g clock-mode-colour blue

# ==============================================================================
# Behavior
# ==============================================================================

# Window monitoring
set -g monitor-activity on

# Automatic rename settings
set -g automatic-rename on
set -g automatic-rename-format "#{b:pane_current_path}"

# ==============================================================================
# Keybindings
# ==============================================================================

# Copy mode entry & prompt navigation
bind-key u copy-mode \; send-keys -X search-backward "❯ "
bind-key -T copy-mode-vi u send-keys -X search-backward "❯ "
bind-key -T copy-mode-vi d send-keys -X search-forward "❯ "

# Helix-like copy mode keybindings
## Helix uses selection-first model: motions extend selection by default
setw -g mode-keys vi

## Enter copy mode with selection started (like Helix select mode)
bind -T copy-mode-vi v send -X begin-selection

## Word motions that extend selection (Helix-style)
bind -T copy-mode-vi w send -X next-word
bind -T copy-mode-vi b send -X previous-word
bind -T copy-mode-vi e send -X next-word-end

## Line selection (x in Helix extends to line)
bind -T copy-mode-vi x send -X select-line

## Goto line start/end (like Helix gh/gl)
bind -T copy-mode-vi g switch-client -T copy-mode-vi-g
bind -T copy-mode-vi-g h send -X start-of-line
bind -T copy-mode-vi-g l send -X end-of-line
bind -T copy-mode-vi-g g send -X history-top
bind -T copy-mode-vi-g e send -X history-bottom

## Match bracket (mm in Helix, but use % for tmux compatibility)
bind -T copy-mode-vi m send -X next-matching-bracket

## Yank selection
bind -T copy-mode-vi y if-shell "uname | grep -q Darwin" \
  "send-keys -X copy-pipe-and-cancel 'pbcopy'" \
  "send-keys -X copy-pipe-and-cancel 'wl-copy'"

# Paste
bind P paste-buffer

# Pane splitting
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# IDE layout (Helix + Claude Code)
bind C-d run-shell 'zsh -c "source ~/.config/zsh/tmux.zsh && ide"'

# Popup toggles (per-window)
bind C-g popup -xC -yC -w80% -h80% -E -d "#{pane_current_path}" '\
  if echo "$(tmux display -p -F "#{session_name}")" | grep -q "^lazygit-" ; then \
    tmux detach-client ; \
  else \
    POPUP_SESSION="lazygit-$(tmux display -p -F "#{window_id}")" ; \
    tmux attach -t "$POPUP_SESSION" || tmux new -s "$POPUP_SESSION" "lazygit" ; \
  fi \
'
bind C-t popup -xC -yC -w80% -h80% -E -d "#{pane_current_path}" '\
  if echo "$(tmux display -p -F "#{session_name}")" | grep -q "^popup-" ; then \
    tmux detach-client ; \
  else \
    POPUP_SESSION="popup-$(tmux display -p -F "#{window_id}")" ; \
    tmux attach -c $(tmux display -p -F "#{pane_current_path}") -t "$POPUP_SESSION" || tmux new -s "$POPUP_SESSION" ; \
  fi \
'
